<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.6.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Shell Style GuideContents1.Shell Files and Interpreter Invocation  1.1 File Extensions  1.2 SUID/SGID     2.Environment   2.1 STDOUT vs STDERR    3.Comments  3.1 File Header   3.2 Function Comments  3">
<meta name="keywords" content="shell">
<meta property="og:type" content="article">
<meta property="og:title" content="shell style guide">
<meta property="og:url" content="http://niuzhiqiang90.coding.me/2017/01/12/shell-style-guide/index.html">
<meta property="og:site_name" content="Just do IT">
<meta property="og:description" content="Shell Style GuideContents1.Shell Files and Interpreter Invocation  1.1 File Extensions  1.2 SUID/SGID     2.Environment   2.1 STDOUT vs STDERR    3.Comments  3.1 File Header   3.2 Function Comments  3">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-01-12T06:09:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="shell style guide">
<meta name="twitter:description" content="Shell Style GuideContents1.Shell Files and Interpreter Invocation  1.1 File Extensions  1.2 SUID/SGID     2.Environment   2.1 STDOUT vs STDERR    3.Comments  3.1 File Header   3.2 Function Comments  3">



  <link rel="alternate" href="/atom.xml" title="Just do IT" type="application/atom+xml">




  <link rel="canonical" href="http://niuzhiqiang90.coding.me/2017/01/12/shell-style-guide/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>shell style guide | Just do IT</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Just do IT</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://niuzhiqiang90.coding.me/2017/01/12/shell-style-guide/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Niu Zhiqiang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Just do IT">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">shell style guide

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-01-12 14:06:39" itemprop="dateCreated datePublished" datetime="2017-01-12T14:06:39+08:00">2017-01-12</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/shell/" itemprop="url" rel="index"><span itemprop="name">shell</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/12/shell-style-guide/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">Comments: </span> <span class="post-comments-count gitment-comments-count" data-xid="/2017/01/12/shell-style-guide/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Shell-Style-Guide"><a href="#Shell-Style-Guide" class="headerlink" title="Shell Style Guide"></a>Shell Style Guide</h1><h2 id="Contents"><a href="#Contents" class="headerlink" title="Contents"></a><span id="contents">Contents</span></h2><p>1.<a href="#a">Shell Files and Interpreter Invocation</a></p>
<ul>
<li><p>1.1 File Extensions</p>
</li>
<li><p>1.2 SUID/SGID  </p>
</li>
</ul>
<p>2.<a href="#b">Environment</a> </p>
<ul>
<li>2.1 STDOUT vs STDERR  </li>
</ul>
<p>3.<a href="#c">Comments</a></p>
<ul>
<li><p>3.1 File Header </p>
</li>
<li><p>3.2 Function Comments</p>
</li>
<li><p>3.3 Implementation Comments</p>
</li>
<li><p>3.4 TODO Comments  </p>
</li>
</ul>
<p>4.<a href="#d">Formatting</a></p>
<ul>
<li><p>4.1 Indentation </p>
</li>
<li><p>4.2 Line Length and Long Strings</p>
</li>
<li><p>4.3 Pipelines | Loops</p>
</li>
<li><p>4.4 Case statement</p>
</li>
<li><p>4.5 Variable expansion</p>
</li>
<li><p>4.6 Quoting  </p>
</li>
</ul>
<p>5.<a href="#e">Features and Bugs</a> </p>
<ul>
<li><p>5.1 Command Substitution</p>
</li>
<li><p>5.2 Test, [ and [[ </p>
</li>
<li><p>5.3 Testing Strings Wildcard Expansion of Filenames </p>
</li>
<li><p>5.4 Eval</p>
</li>
<li><p>5.5 Pipes to While  </p>
</li>
</ul>
<p>6.<a href="#f">Naming Conventions</a></p>
<ul>
<li><p>6.1 Function Names </p>
</li>
<li><p>6.2 Variable Names </p>
</li>
<li><p>6.3 Constants and Environment Variable Names </p>
</li>
<li><p>6.4 Source Filenames </p>
</li>
<li><p>6.5 Read-only Variables </p>
</li>
<li><p>6.7 Use Local Variables </p>
</li>
<li><p>6.8 Function Location </p>
</li>
<li><p>6.9 main  </p>
</li>
</ul>
<p>7.<a href="#g">Calling Commands</a></p>
<ul>
<li><p>7.1 Checking Return Values </p>
</li>
<li><p>7.2 Builtin Commands vs. External Commands  </p>
</li>
</ul>
<p>8.<a href="#h">Conclusion</a></p>
<h2 id="Which-Shell-to-Use"><a href="#Which-Shell-to-Use" class="headerlink" title="Which Shell to Use"></a>Which Shell to Use</h2><p><strong>Bash</strong> is the only shell scripting language permitted for executables.  </p>
<p>Executables must start with <strong>#! /bin/bash</strong> and a minimum number of flags.</p>
<p>Use <strong>set</strong> to set shell options so that calling your script as <strong>bash</strong> <strong><em>script_name</em></strong> does not break its functionality.</p>
<p>Restricting all executable shell scripts to bash gives us a consistent shell language that’s installed on all our machines.</p>
<p>The only exception to this is where you’re forced to by whatever you’re coding for.</p>
<p>One example of this is Solaris SVR4 packages which require plain Bourne shell for any scripts.</p>
<h2 id="When-to-use-Shell"><a href="#When-to-use-Shell" class="headerlink" title="When to use Shell"></a>When to use Shell</h2><p>Shell should only be used for small utilities or simple wrapper scripts.  </p>
<p>While shell scripting isn’t a development language, it is used for writing various utility scripts throughout Google.   This style guide is more a recognition of its use rather than a suggestion that it be used for widespread deployment.</p>
<p>Some guidelines:</p>
<ul>
<li><p>If you’re mostly calling other utilities and are doing relatively little data manipulation, shell is an acceptable choice for the task.</p>
</li>
<li><p>If performance matters, use something other than shell.</p>
</li>
<li><p>If you find you need to use arrays for anything more than assignment of <strong>${PIPESTATUS}</strong>, you should use Python.</p>
</li>
<li><p>If you are writing a script that is more than 100 lines long, you should probably be writing it in Python instead. Bear in mind that scripts grow. Rewrite your script in another language early to avoid a time-consuming rewrite at a later date.  </p>
</li>
</ul>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="1-Shell-Files-and-Interpreter-Invocation"><a href="#1-Shell-Files-and-Interpreter-Invocation" class="headerlink" title="1.  Shell Files and Interpreter Invocation"></a>1.  <span id="a">Shell Files and Interpreter Invocation</span></h2><h3 id="1-1-File-Extensions"><a href="#1-1-File-Extensions" class="headerlink" title="1.1 File Extensions"></a>1.1 File Extensions</h3><p>Executables should have no extension (strongly preferred) or a <strong>.sh</strong> extension. Libraries must have a <strong>.sh</strong> extension and should not be executable.</p>
<p>It is not necessary to know what language a program is written in when executing it and shell doesn’t require an extension so we prefer not to use one for executables.</p>
<p>However, for libraries it’s important to know what language it is and sometimes there’s a need to have similar libraries in different languages. This allows library files with identical purposes but different languages to be identically named except for the language-specific suffix.</p>
<h3 id="1-2-SUID-SGID"><a href="#1-2-SUID-SGID" class="headerlink" title="1.2 SUID/SGID"></a>1.2 SUID/SGID</h3><p>SUID and SGID are forbidden on shell scripts.</p>
<p>There are too many security issues with shell that make it nearly impossible to secure sufficiently to allow SUID/SGID. While bash does make it difficult to run SUID, it’s still possible on some platforms which is why we’re being explicit about banning it.</p>
<p>Use <strong>sudo</strong> to provide elevated access if you need it.</p>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="2-Environment"><a href="#2-Environment" class="headerlink" title="2. Environment"></a>2. <span id="b">Environment</span></h2><h3 id="2-1-STDOUT-vs-STDERR"><a href="#2-1-STDOUT-vs-STDERR" class="headerlink" title="2.1 STDOUT vs STDERR"></a>2.1 STDOUT vs STDERR</h3><p>All error messages should go to <strong>STDERR</strong>.</p>
<p>This makes it easier to separate normal status from actual issues.</p>
<p>A function to print out error messages along with other status information is recommended.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">err() &#123;</span><br><span class="line"></span><br><span class="line">  echo &quot;[$(date +&apos;%Y-%m-%dT%H:%M:%S%z&apos;)]: $@&quot; &gt;&amp;2</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if ! do_something; then</span><br><span class="line"></span><br><span class="line">  err &quot;Unable to do_something&quot;</span><br><span class="line"></span><br><span class="line">  exit &quot;$&#123;E_DID_NOTHING&#125;&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="3-Comments"><a href="#3-Comments" class="headerlink" title="3. Comments"></a>3. <span id="c">Comments</span></h2><h3 id="3-1-File-Header"><a href="#3-1-File-Header" class="headerlink" title="3.1 File Header"></a>3.1 File Header</h3><p>Start each file with a description of its contents.</p>
<p>Every file must have a top-level comment including a brief overview of its contents. A copyright notice and author information are optional.</p>
<p><strong><em>Example:</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Perform hot backups of Oracle databases.</span><br></pre></td></tr></table></figure>
<h3 id="3-2-Function-Comments"><a href="#3-2-Function-Comments" class="headerlink" title="3.2 Function Comments"></a>3.2 Function Comments</h3><p>Any function that is not both obvious and short must be commented. Any function in a library must be commented regardless of length or complexity.</p>
<p>It should be possible for someone else to learn how to use your program or to use a function in your library by reading the comments (and self-help, if provided) without reading the code.</p>
<p>All function comments should contain:</p>
<ul>
<li><p>Description of the function</p>
</li>
<li><p>Global variables used and modified</p>
</li>
<li><p>Arguments taken</p>
</li>
<li><p>Returned values other than the default exit status of the last command run</p>
</li>
</ul>
<p><strong><em>Example:</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># Perform hot backups of Oracle databases.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">export PATH=&apos;/usr/xpg4/bin:/usr/bin:/opt/csw/bin:/opt/goog/bin&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#######################################</span><br><span class="line"></span><br><span class="line"># Cleanup files from the backup dir</span><br><span class="line"></span><br><span class="line"># Globals:</span><br><span class="line"></span><br><span class="line">#   BACKUP_DIR</span><br><span class="line"></span><br><span class="line">#   ORACLE_SID</span><br><span class="line"></span><br><span class="line"># Arguments:</span><br><span class="line"></span><br><span class="line">#   None</span><br><span class="line"></span><br><span class="line"># Returns:</span><br><span class="line"></span><br><span class="line">#   None</span><br><span class="line"></span><br><span class="line">#######################################</span><br><span class="line"></span><br><span class="line">cleanup() &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-Implementation-Comments"><a href="#3-3-Implementation-Comments" class="headerlink" title="3.3 Implementation Comments"></a>3.3 Implementation Comments</h3><p>Comment tricky, non-obvious, interesting or important parts of your code.</p>
<p>This follows general Google coding comment practice. Don’t comment everything. If there’s a complex algorithm or you’re doing something out of the ordinary, put a short comment in.</p>
<h3 id="3-4-TODO-Comments"><a href="#3-4-TODO-Comments" class="headerlink" title="3.4 TODO Comments"></a>3.4 TODO Comments</h3><p>Use <strong>TODO</strong> comments for code that is temporary, a short-term solution, or good-enough but not perfect.</p>
<p>This matches the convention in the <strong>C++ Guide</strong>.</p>
<p><strong>TODOs</strong> should include the string <strong>TODO</strong> in all caps, followed by your username in parentheses. A colon is optional. It’s preferable to put a bug/ticket number next to the <strong>TODO</strong> item as well.</p>
<p><strong><em>Examples:</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># TODO(mrmonkey): Handle the unlikely edge cases (bug ####)</span><br></pre></td></tr></table></figure>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="4-Formatting"><a href="#4-Formatting" class="headerlink" title="4. Formatting"></a>4. <span id="d">Formatting</span></h2><p>While you should follow the style that’s already there for files that you’re modifying, the following are required for any new code.</p>
<h3 id="4-1-Indentation"><a href="#4-1-Indentation" class="headerlink" title="4.1 Indentation"></a>4.1 Indentation</h3><p>Indent 2 spaces. No tabs.</p>
<p>Use blank lines between blocks to improve readability. Indentation is two spaces. Whatever you do, don’t use tabs. For existing files, stay faithful to the existing indentation.</p>
<h3 id="4-2-Line-Length-and-Long-Strings"><a href="#4-2-Line-Length-and-Long-Strings" class="headerlink" title="4.2 Line Length and Long Strings"></a>4.2 Line Length and Long Strings</h3><p>Maximum line length is 80 characters.</p>
<p>If you have to write strings that are longer than 80 characters, this should be done with a here document or an embedded newline if possible. Literal strings that have to be longer than 80 chars and can’t sensibly be split are ok, but it’s strongly preferred to find a way to make it shorter.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># DO use &apos;here document&apos;s</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;END;</span><br><span class="line"></span><br><span class="line">I am an exceptionally long</span><br><span class="line"></span><br><span class="line">string.</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Embedded newlines are ok too</span><br><span class="line"></span><br><span class="line">long_string=&quot;I am an exceptionally</span><br><span class="line"></span><br><span class="line">  long string.&quot;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-Pipelines"><a href="#4-3-Pipelines" class="headerlink" title="4.3 Pipelines"></a>4.3 Pipelines</h3><p>Pipelines should be split one per line if they don’t all fit on one line.</p>
<p>If a pipeline all fits on one line, it should be on one line.</p>
<p>If not, it should be split at one pipe segment per line with the pipe on the newline and a 2 space indent for the next section of the pipe. This applies to a chain of commands combined using ‘<strong>|</strong>‘ as well as to logical compounds using ‘<strong>||</strong>‘ and ‘<strong>&amp;&amp;</strong>‘.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># All fits on one line</span><br><span class="line"></span><br><span class="line">command1 | command2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Long commands</span><br><span class="line"></span><br><span class="line">command1 \</span><br><span class="line"></span><br><span class="line">  | command2 \</span><br><span class="line"></span><br><span class="line">  | command3 \</span><br><span class="line"></span><br><span class="line">  | command4</span><br></pre></td></tr></table></figure>
<h3 id="4-4-Loops"><a href="#4-4-Loops" class="headerlink" title="4.4 Loops"></a>4.4 Loops</h3><p>Put <strong>; do</strong> and <strong>; then</strong> on the same line as the <strong>while</strong>, <strong>for</strong> or <strong>if</strong>.</p>
<p>Loops in shell are a bit different, but we follow the same principles as with braces when declaring functions.</p>
<p>That is: <strong>; then</strong> and <strong>; do</strong> should be <font color="red">on the same line</font> as the <strong>if/for/while</strong>.<strong>else</strong> should be on its own line and closing statements should be on their own line vertically aligned with the opening statement.</p>
<p><strong><em>Example:</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">for dir in $&#123;dirs_to_cleanup&#125;; do</span><br><span class="line"></span><br><span class="line">  if [[ -d &quot;$&#123;dir&#125;/$&#123;ORACLE_SID&#125;&quot; ]]; then</span><br><span class="line"></span><br><span class="line">    log_date &quot;Cleaning up old files in $&#123;dir&#125;/$&#123;ORACLE_SID&#125;&quot;</span><br><span class="line"></span><br><span class="line">    rm &quot;$&#123;dir&#125;/$&#123;ORACLE_SID&#125;/&quot;*</span><br><span class="line"></span><br><span class="line">    if [[ &quot;$?&quot; -ne 0 ]]; then</span><br><span class="line"></span><br><span class="line">      error_message</span><br><span class="line"></span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">  else</span><br><span class="line"></span><br><span class="line">    mkdir -p &quot;$&#123;dir&#125;/$&#123;ORACLE_SID&#125;&quot;</span><br><span class="line"></span><br><span class="line">    if [[ &quot;$?&quot; -ne 0 ]]; then</span><br><span class="line"></span><br><span class="line">      error_message</span><br><span class="line"></span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="4-5-Case-statement"><a href="#4-5-Case-statement" class="headerlink" title="4.5 Case statement"></a>4.5 Case statement</h3><ul>
<li><p>Indent alternatives by 2 spaces.</p>
</li>
<li><p>A one-line alternative needs a space after the close parenthesis of the pattern and before the <strong>;;</strong>.</p>
</li>
<li><p>Long or multi-command alternatives should be split over multiple lines with the pattern, actions, and <strong>;;</strong> on separate lines.</p>
</li>
</ul>
<p>The matching expressions are indented one level from the ‘<strong>case</strong>‘ and ‘<strong>esac</strong>‘. Multiline actions are indented another level. In general, there is no need to quote match expressions. Pattern expressions should not be preceded by an open parenthesis. Avoid the <strong>;&amp;</strong> and <strong>;;&amp;</strong> notations.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">case &quot;$&#123;expression&#125;&quot; in</span><br><span class="line"></span><br><span class="line">  a)</span><br><span class="line"></span><br><span class="line">    variable=&quot;...&quot;</span><br><span class="line"></span><br><span class="line">    some_command &quot;$&#123;variable&#125;&quot; &quot;$&#123;other_expr&#125;&quot; ...</span><br><span class="line"></span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  absolute)</span><br><span class="line"></span><br><span class="line">    actions=&quot;relative&quot;</span><br><span class="line"></span><br><span class="line">    another_command &quot;$&#123;actions&#125;&quot; &quot;$&#123;other_expr&#125;&quot; ...</span><br><span class="line"></span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">  *)</span><br><span class="line"></span><br><span class="line">    error &quot;Unexpected expression &apos;$&#123;expression&#125;&apos;&quot;</span><br><span class="line"></span><br><span class="line">    ;;</span><br><span class="line"></span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<p>Simple commands may be put on the same line as the pattern and <strong>;;</strong> as long as the expression remains readable. This is often appropriate for single-letter option processing. When the actions don’t fit on a single line, put the pattern on a line on its own, then the actions, then <strong>;;</strong>; also <font color="red"> on a line of its own</font>. When on the same line as the actions, use a space after the close parenthesis of the pattern and another before the <strong>;;</strong>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">verbose=&apos;false&apos;</span><br><span class="line"></span><br><span class="line">aflag=&apos;&apos;</span><br><span class="line"></span><br><span class="line">bflag=&apos;&apos;</span><br><span class="line"></span><br><span class="line">files=&apos;&apos;</span><br><span class="line"></span><br><span class="line">while getopts &apos;abf:v&apos; flag; do</span><br><span class="line"></span><br><span class="line">  case &quot;$&#123;flag&#125;&quot; in</span><br><span class="line"></span><br><span class="line">    a) aflag=&apos;true&apos; ;;</span><br><span class="line"></span><br><span class="line">    b) bflag=&apos;true&apos; ;;</span><br><span class="line"></span><br><span class="line">    f) files=&quot;$&#123;OPTARG&#125;&quot; ;;</span><br><span class="line"></span><br><span class="line">    v) verbose=&apos;true&apos; ;;</span><br><span class="line"></span><br><span class="line">    *) error &quot;Unexpected option $&#123;flag&#125;&quot; ;;</span><br><span class="line"></span><br><span class="line">  esac</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="4-6-Variable-expansion"><a href="#4-6-Variable-expansion" class="headerlink" title="4.6 Variable expansion"></a>4.6 Variable expansion</h3><p>In order of precedence: Stay consistent with what you find; quote your variables; prefer “<strong>${var}</strong>“ over “<strong>$var</strong>“, but see details.</p>
<p>These are meant to be guidelines, as the topic seems too controversial for a mandatory regulation.</p>
<p>They are listed in order of precedence.</p>
<ol>
<li><p>Stay consistent with what you find for existing code.</p>
</li>
<li><p>Quote variables, see Quoting section below.</p>
</li>
<li><p>Don’t brace-quote single character shell specials / positional parameters, unless strictly necessary or avoiding deep confusion.</p>
</li>
</ol>
<p>Prefer brace-quoting all other variables.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Section of recommended cases.</span><br><span class="line"></span><br><span class="line"># Preferred style for &apos;special&apos; variables:</span><br><span class="line"></span><br><span class="line">echo &quot;Positional: $1&quot; &quot;$5&quot; &quot;$3&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;Specials: !=$!, -=$-, _=$_. ?=$?, #=$# *=$* @=$@ \$=$$ ...&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Braces necessary:</span><br><span class="line"></span><br><span class="line">echo &quot;many parameters: $&#123;10&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Braces avoiding confusion:</span><br><span class="line"></span><br><span class="line"># Output is &quot;a0b0c0&quot;</span><br><span class="line"></span><br><span class="line">set -- a b c</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;1&#125;0$&#123;2&#125;0$&#123;3&#125;0&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Preferred style for other variables:</span><br><span class="line"></span><br><span class="line">echo &quot;PATH=$&#123;PATH&#125;, PWD=$&#123;PWD&#125;, mine=$&#123;some_var&#125;&quot;</span><br><span class="line"></span><br><span class="line">while read f; do</span><br><span class="line"></span><br><span class="line">  echo &quot;file=$&#123;f&#125;&quot;</span><br><span class="line"></span><br><span class="line">done &lt; &lt;(ls -l /tmp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Section of discouraged cases</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Unquoted vars, unbraced vars, brace-quoted single letter</span><br><span class="line"></span><br><span class="line"># shell specials.</span><br><span class="line"></span><br><span class="line">echo a=$avar &quot;b=$bvar&quot; &quot;PID=$&#123;$&#125;&quot; &quot;$&#123;1&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Confusing use: this is expanded as &quot;$&#123;1&#125;0$&#123;2&#125;0$&#123;3&#125;0&quot;,</span><br><span class="line"></span><br><span class="line"># not &quot;$&#123;10&#125;$&#123;20&#125;$&#123;30&#125;</span><br><span class="line"></span><br><span class="line">set -- a b c</span><br><span class="line"></span><br><span class="line">echo &quot;$10$20$30&quot;</span><br></pre></td></tr></table></figure>
<h3 id="4-7-Quoting"><a href="#4-7-Quoting" class="headerlink" title="4.7 Quoting"></a>4.7 Quoting</h3><ul>
<li><p>Always quote strings containing variables, command substitutions, spaces or shell meta characters, unless careful unquoted expansion is required.</p>
</li>
<li><p>Prefer quoting strings that are “words” (as opposed to command options or path names).</p>
</li>
<li><p>Never quote <strong><em>literal</em></strong> integers.</p>
</li>
<li><p>Be aware of the quoting rules for pattern matches in [[.</p>
</li>
<li><p>Use “<strong>$@</strong>“ unless you have a specific reason to use <strong>$*</strong>.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># &apos;Single&apos; quotes indicate that no substitution is desired.</span><br><span class="line"></span><br><span class="line"># &quot;Double&quot; quotes indicate that substitution is required/tolerated.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Simple examples</span><br><span class="line"></span><br><span class="line"># &quot;quote command substitutions&quot;</span><br><span class="line"></span><br><span class="line">flag=&quot;$(some_command and its args &quot;$@&quot; &apos;quoted separately&apos;)&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># &quot;quote variables&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;flag&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># &quot;never quote literal integers&quot;</span><br><span class="line"></span><br><span class="line">value=32</span><br><span class="line"></span><br><span class="line"># &quot;quote command substitutions&quot;, even when you expect integers</span><br><span class="line"></span><br><span class="line">number=&quot;$(generate_number)&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># &quot;prefer quoting words&quot;, not compulsory</span><br><span class="line"></span><br><span class="line">readonly USE_INTEGER=&apos;true&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># &quot;quote shell meta characters&quot;</span><br><span class="line"></span><br><span class="line">echo &apos;Hello stranger, and well met. Earn lots of $$$&apos;</span><br><span class="line"></span><br><span class="line">echo &quot;Process $$: Done making \$\$\$.&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># &quot;command options or path names&quot;</span><br><span class="line"></span><br><span class="line"># ($1 is assumed to contain a value here)</span><br><span class="line"></span><br><span class="line">grep -li Hugo /dev/null &quot;$1&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Less simple examples</span><br><span class="line"></span><br><span class="line"># &quot;quote variables, unless proven false&quot;: ccs might be empty</span><br><span class="line"></span><br><span class="line">git send-email --to &quot;$&#123;reviewers&#125;&quot; $&#123;ccs:+&quot;--cc&quot; &quot;$&#123;ccs&#125;&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Positional parameter precautions: $1 might be unset</span><br><span class="line"></span><br><span class="line"># Single quotes leave regex as-is.</span><br><span class="line"></span><br><span class="line">grep -cP &apos;([Ss]pecial|\|?characters*)$&apos; $&#123;1:+&quot;$1&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># For passing on arguments,</span><br><span class="line"></span><br><span class="line"># &quot;$@&quot; is right almost everytime, and</span><br><span class="line"></span><br><span class="line"># $* is wrong almost everytime:</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"># * $* and $@ will split on spaces, clobbering up arguments</span><br><span class="line"></span><br><span class="line">#   that contain spaces and dropping empty strings;</span><br><span class="line"></span><br><span class="line"># * &quot;$@&quot; will retain arguments as-is, so no args</span><br><span class="line"></span><br><span class="line">#   provided will result in no args being passed on;</span><br><span class="line"></span><br><span class="line">#   This is in most cases what you want to use for passing</span><br><span class="line"></span><br><span class="line">#   on arguments.</span><br><span class="line"></span><br><span class="line"># * &quot;$*&quot; expands to one argument, with all args joined</span><br><span class="line"></span><br><span class="line">#   by (usually) spaces,</span><br><span class="line"></span><br><span class="line">#   so no args provided will result in one empty string</span><br><span class="line"></span><br><span class="line">#   being passed on.</span><br><span class="line"></span><br><span class="line"># (Consult &apos;man bash&apos; for the nit-grits ;-)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">set -- 1 &quot;2 two&quot; &quot;3 three tres&quot;; echo $# ; set -- &quot;$*&quot;; echo &quot;$#, $@&quot;)</span><br><span class="line"></span><br><span class="line">set -- 1 &quot;2 two&quot; &quot;3 three tres&quot;; echo $# ; set -- &quot;$@&quot;; echo &quot;$#, $@&quot;)</span><br></pre></td></tr></table></figure>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="5-Features-and-Bugs"><a href="#5-Features-and-Bugs" class="headerlink" title="5. Features and Bugs"></a>5. <span id="e">Features and Bugs</span></h2><h3 id="5-1-Command-Substitution"><a href="#5-1-Command-Substitution" class="headerlink" title="5.1 Command Substitution"></a>5.1 Command Substitution</h3><p>Use <strong>$(command)</strong> instead of backticks.</p>
<p>Nested backticks require escaping the inner ones with <strong>.</strong> The <strong>$(command)</strong> format doesn’t change when nested and is easier to read.</p>
<p><strong><em>Example:</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># This is preferred:</span><br><span class="line"></span><br><span class="line">var=&quot;$(command &quot;$(command1)&quot;)&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This is not:</span><br><span class="line"></span><br><span class="line">var=&quot;`command \`command1\``&quot;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-Test-and"><a href="#5-2-Test-and" class="headerlink" title="5.2 Test, [ and [["></a>5.2 Test, [ and [[</h3><p><strong>[[ … ]]</strong> is preferred over <strong>[</strong>, <strong>test</strong> and <strong>/usr/bin/[</strong>.</p>
<p><strong>[[ … ]]</strong> reduces errors as no pathname expansion or word splitting takes place between <strong>[[ and ]]</strong> and <strong>[[ … ]]</strong> allows for regular expression matching where [ … ] does not.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># This ensures the string on the left is made up of characters in the</span><br><span class="line"></span><br><span class="line"># alnum character class followed by the string name.</span><br><span class="line"></span><br><span class="line"># Note that the RHS should not be quoted here.</span><br><span class="line"></span><br><span class="line"># For the gory details, see</span><br><span class="line"></span><br><span class="line"># E14 at http://tiswww.case.edu/php/chet/bash/FAQ</span><br><span class="line"></span><br><span class="line">if [[ &quot;filename&quot; =~ ^[[:alnum:]]+name ]]; then</span><br><span class="line"></span><br><span class="line">  echo &quot;Match&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This matches the exact pattern &quot;f*&quot; (Does not match in this case)</span><br><span class="line"></span><br><span class="line">if [[ &quot;filename&quot; == &quot;f*&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  echo &quot;Match&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This gives a &quot;too many arguments&quot; error as f* is expanded to the</span><br><span class="line"></span><br><span class="line"># contents of the current directory</span><br><span class="line"></span><br><span class="line">if [ &quot;filename&quot; == f* ]; then</span><br><span class="line"></span><br><span class="line">  echo &quot;Match&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="5-3-Testing-Strings"><a href="#5-3-Testing-Strings" class="headerlink" title="5.3 Testing Strings"></a>5.3 Testing Strings</h3><p>Use quotes rather than filler characters where possible.</p>
<p>Bash is smart enough to deal with an empty string in a test. So, given that the code is much easier to read, use tests for empty/non-empty strings or empty strings rather than filler characters.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Do this:</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;my_var&#125;&quot; = &quot;some_string&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># -z (string length is zero) and -n (string length is not zero) are</span><br><span class="line"></span><br><span class="line"># preferred over testing for an empty string</span><br><span class="line"></span><br><span class="line">if [[ -z &quot;$&#123;my_var&#125;&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This is OK (ensure quotes on the empty side), but not preferred:</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;my_var&#125;&quot; = &quot;&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Not this:</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;my_var&#125;X&quot; = &quot;some_stringX&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>To avoid confusion about what you’re testing for, explicitly use <strong>-z</strong> or <strong>-n</strong>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Use this</span><br><span class="line"></span><br><span class="line">if [[ -n &quot;$&#123;my_var&#125;&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Instead of this as errors can occur if $&#123;my_var&#125; expands to a test</span><br><span class="line"></span><br><span class="line"># flag</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;my_var&#125;&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="5-4-Wildcard-Expansion-of-Filenames"><a href="#5-4-Wildcard-Expansion-of-Filenames" class="headerlink" title="5.4 Wildcard Expansion of Filenames"></a>5.4 Wildcard Expansion of Filenames</h3><p>Use an explicit path when doing wildcard expansion of filenames.</p>
<p>As filenames can begin with a -, it’s a lot safer to expand wildcards with ./<em> instead of </em> .</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Here&apos;s the contents of the directory:</span><br><span class="line"></span><br><span class="line"># -f  -r  somedir  somefile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This deletes almost everything in the directory by force</span><br><span class="line"></span><br><span class="line">psa@bilby$ rm -v *</span><br><span class="line"></span><br><span class="line">removed directory: `somedir&apos;</span><br><span class="line"></span><br><span class="line">removed `somefile&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># As opposed to:</span><br><span class="line"></span><br><span class="line">psa@bilby$ rm -v ./*</span><br><span class="line"></span><br><span class="line">removed `./-f&apos;</span><br><span class="line"></span><br><span class="line">removed `./-r&apos;</span><br><span class="line"></span><br><span class="line">rm: cannot remove `./somedir&apos;: Is a directory</span><br><span class="line"></span><br><span class="line">removed `./somefile&apos;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-Eval"><a href="#5-5-Eval" class="headerlink" title="5.5 Eval"></a>5.5 Eval</h3><p><strong>eval</strong> should be avoided.  </p>
<p>Eval munges the input when used for assignment to variables and can set variables without making it possible to check what those variables were.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># What does this set?</span><br><span class="line"></span><br><span class="line"># Did it succeed? In part or whole?</span><br><span class="line"></span><br><span class="line">eval $(set_my_variables)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># What happens if one of the returned values has a space in it?</span><br><span class="line"></span><br><span class="line">variable=&quot;$(eval some_function)&quot;</span><br></pre></td></tr></table></figure>
<h3 id="5-6-Pipes-to-While"><a href="#5-6-Pipes-to-While" class="headerlink" title="5.6 Pipes to While"></a>5.6 Pipes to While</h3><p>Use process substitution or for loops in preference to piping to while. Variables modified in a while loop do not propagate to the parent because the loop’s commands run in a subshell.</p>
<p>The implicit subshell in a pipe to while can make it difficult to track down bugs.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">last_line=&apos;NULL&apos;</span><br><span class="line"></span><br><span class="line">your_command | while read line; do</span><br><span class="line"></span><br><span class="line">  last_line=&quot;$&#123;line&#125;&quot;</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This will output &apos;NULL&apos;</span><br><span class="line"></span><br><span class="line">echo &quot;$&#123;last_line&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>Use a for loop if you are confident that the input will not contain spaces or special characters (usually, this means not user input).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">total=0</span><br><span class="line"></span><br><span class="line"># Only do this if there are no spaces in return values.</span><br><span class="line"></span><br><span class="line">for value in $(command); do</span><br><span class="line"></span><br><span class="line">  total+=&quot;$&#123;value&#125;&quot;</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>Using process substitution allows redirecting output but puts the commands in an explicit subshell rather than the implicit subshell that bash creates for the while loop.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">total=0</span><br><span class="line"></span><br><span class="line">last_file=</span><br><span class="line"></span><br><span class="line">while read count filename; do</span><br><span class="line"></span><br><span class="line">  total+=&quot;$&#123;count&#125;&quot;</span><br><span class="line"></span><br><span class="line">  last_file=&quot;$&#123;filename&#125;&quot;</span><br><span class="line"></span><br><span class="line">done &lt; &lt;(your_command | uniq -c)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This will output the second field of the last line of output from</span><br><span class="line"></span><br><span class="line"># the command.</span><br><span class="line"></span><br><span class="line">echo &quot;Total = $&#123;total&#125;&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;Last one = $&#123;last_file&#125;&quot;</span><br></pre></td></tr></table></figure>
<p>Use while loops where it is not necessary to pass complex results to the parent shell - this is typically where some more complex “parsing” is required. Beware that simple examples are probably more easily done with a tool such as awk. This may also be useful where you specifically don’t want to change the parent scope variables.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Trivial implementation of awk expression:</span><br><span class="line"></span><br><span class="line">#   awk &apos;$3 == &quot;nfs&quot; &#123; print $2 &quot; maps to &quot; $1 &#125;&apos; /proc/mounts</span><br><span class="line"></span><br><span class="line">cat /proc/mounts | while read src dest type opts rest; do</span><br><span class="line"></span><br><span class="line">  if [[ $&#123;type&#125; == &quot;nfs&quot; ]]; then</span><br><span class="line"></span><br><span class="line">    echo &quot;NFS $&#123;dest&#125; maps to $&#123;src&#125;&quot;</span><br><span class="line"></span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="6-Naming-Conventions"><a href="#6-Naming-Conventions" class="headerlink" title="6. Naming Conventions"></a>6. <span id="f">Naming Conventions</span></h2><h3 id="6-1-Function-Names"><a href="#6-1-Function-Names" class="headerlink" title="6.1 Function Names"></a>6.1 Function Names</h3><p>Lower-case, with underscores to separate words. Separate libraries with <strong>::</strong>. Parentheses are required after the function name. The keyword <strong><em>function</em></strong> is optional, but must be used consistently throughout a project.</p>
<p>If you’re writing single functions, use lowercase and separate words with underscore. If you’re writing a package, separate package names with <strong>::</strong>. Braces must be on the same line as the function name (as with other languages at Google) and no space between the function name and the parenthesis.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Single function</span><br><span class="line"></span><br><span class="line">my_func() &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Part of a package</span><br><span class="line"></span><br><span class="line">mypackage::my_func() &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <strong>function</strong> keyword is extraneous when “()” is present after the function name, but enhances quick identification of functions.</p>
<h3 id="6-2-Variable-Names"><a href="#6-2-Variable-Names" class="headerlink" title="6.2 Variable Names"></a>6.2 Variable Names</h3><p>As for function names.</p>
<p>Variables names for loops should be similarly named for any variable you’re looping through.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">for zone in $&#123;zones&#125;; do</span><br><span class="line"></span><br><span class="line">  something_with &quot;$&#123;zone&#125;&quot;</span><br><span class="line"></span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="6-3-Constants-and-Environment-Variable-Names"><a href="#6-3-Constants-and-Environment-Variable-Names" class="headerlink" title="6.3 Constants and Environment Variable Names"></a>6.3 Constants and Environment Variable Names</h3><p>All caps, separated with underscores, declared at the top of the file.</p>
<p>Constants and anything exported to the environment should be capitalized.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Constant</span><br><span class="line"></span><br><span class="line">readonly PATH_TO_FILES=&apos;/some/path&apos;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Both constant and environment</span><br><span class="line"></span><br><span class="line">declare -xr ORACLE_SID=&apos;PROD&apos;</span><br></pre></td></tr></table></figure>
<p>Some things become constant at their first setting (for example, via getopts). Thus, it’s OK to set a constant in getopts or based on a condition, but it should be made readonly immediately afterwards. Note that <strong>declare</strong> doesn’t operate on global variables within functions, so <strong>readonly</strong> or <strong>export</strong> is recommended instead.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">VERBOSE=&apos;false&apos;</span><br><span class="line"></span><br><span class="line">while getopts &apos;v&apos; flag; do</span><br><span class="line"></span><br><span class="line">  case &quot;$&#123;flag&#125;&quot; in</span><br><span class="line"></span><br><span class="line">    v) VERBOSE=&apos;true&apos; ;;</span><br><span class="line"></span><br><span class="line">  esac</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">readonly VERBOSE</span><br></pre></td></tr></table></figure>
<h3 id="6-4-Source-Filenames"><a href="#6-4-Source-Filenames" class="headerlink" title="6.4 Source Filenames"></a>6.4 Source Filenames</h3><p>Lowercase, with underscores to separate words if desired.</p>
<p>This is for consistency with other code styles in Google: <strong>maketemplate</strong> or <strong>make_template</strong> but <font color="red">not</font> <strong>make-template</strong>.</p>
<h3 id="6-5-Read-only-Variables"><a href="#6-5-Read-only-Variables" class="headerlink" title="6.5 Read-only Variables"></a>6.5 Read-only Variables</h3><p>Use <strong>readonly</strong> or <strong>declare -r</strong> to ensure they’re read only.</p>
<p>As globals are widely used in shell, it’s important to catch errors when working with them. When you declare a variable that is meant to be read-only, make this explicit.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zip_version=&quot;$(dpkg --status zip | grep Version: | cut -d &apos; &apos; -f 2)&quot;</span><br><span class="line"></span><br><span class="line">if [[ -z &quot;$&#123;zip_version&#125;&quot; ]]; then</span><br><span class="line"></span><br><span class="line">  error_message</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">  readonly zip_version</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="6-6-Use-Local-Variables"><a href="#6-6-Use-Local-Variables" class="headerlink" title="6.6 Use Local Variables"></a>6.6 Use Local Variables</h3><p>Declare function-specific variables with <strong>local</strong>. Declaration and assignment should be on different lines.</p>
<p>Ensure that local variables are only seen inside a function and its children by using <strong>local</strong> when declaring them. This avoids polluting the global name space and inadvertently setting variables that may have significance outside the function.</p>
<p>Declaration and assignment must be separate statements when the assignment value is provided by a command substitution; as the ‘local’ builtin does not propagate the exit code from the command substitution.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">my_func2() &#123;</span><br><span class="line"></span><br><span class="line">  local name=&quot;$1&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # Separate lines for declaration and assignment:</span><br><span class="line"></span><br><span class="line">  local my_var</span><br><span class="line"></span><br><span class="line">  my_var=&quot;$(my_func)&quot; || return</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # DO NOT do this: $? contains the exit code of &apos;local&apos;, not my_func</span><br><span class="line"></span><br><span class="line">  local my_var=&quot;$(my_func)&quot;</span><br><span class="line"></span><br><span class="line">  [[ $? -eq 0 ]] || return</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-7-Function-Location"><a href="#6-7-Function-Location" class="headerlink" title="6.7 Function Location"></a>6.7 Function Location</h3><p>Put all functions together in the file just below constants. Don’t hide executable code between functions.</p>
<p>If you’ve got functions, put them all together near the top of the file. Only includes, <strong>set</strong> statements and setting constants may be done before declaring functions.</p>
<p>Don’t hide executable code between functions. Doing so makes the code difficult to follow and results in nasty surprises when debugging.</p>
<h3 id="6-8-main"><a href="#6-8-main" class="headerlink" title="6.8 main"></a>6.8 main</h3><p>A function called <strong><em>main</em></strong> is required for scripts long enough to contain at least one other function.</p>
<p>In order to easily find the start of the program, put the main program in a function called <strong>main</strong> as the bottom most function. This provides consistency with the rest of the code base as well as allowing you to define more variables as <strong>local</strong> (which can’t be done if the main code is not a function). The last non-comment line in the file should be a call to <strong>main</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<p>Obviously, for short scripts where it’s just a linear flow, <strong>main</strong> is overkill and so is not required.</p>
<h2 id="7-Calling-Commands"><a href="#7-Calling-Commands" class="headerlink" title="7. Calling Commands"></a>7. <span id="g">Calling Commands</span></h2><h3 id="7-1-Checking-Return-Values"><a href="#7-1-Checking-Return-Values" class="headerlink" title="7.1 Checking Return Values"></a>7.1 Checking Return Values</h3><p>Always check return values and give informative return values.</p>
<p>For unpiped commands, use <strong>$?</strong> or check directly via an <strong>if</strong> statement to keep it simple.</p>
<p>Example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">if ! mv &quot;$&#123;file_list&#125;&quot; &quot;$&#123;dest_dir&#125;/&quot; ; then</span><br><span class="line"></span><br><span class="line">  echo &quot;Unable to move $&#123;file_list&#125; to $&#123;dest_dir&#125;&quot; &gt;&amp;2</span><br><span class="line"></span><br><span class="line">  exit &quot;$&#123;E_BAD_MOVE&#125;&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Or</span><br><span class="line"></span><br><span class="line">mv &quot;$&#123;file_list&#125;&quot; &quot;$&#123;dest_dir&#125;/&quot;</span><br><span class="line"></span><br><span class="line">if [[ &quot;$?&quot; -ne 0 ]]; then</span><br><span class="line"></span><br><span class="line">  echo &quot;Unable to move $&#123;file_list&#125; to $&#123;dest_dir&#125;&quot; &gt;&amp;2</span><br><span class="line"></span><br><span class="line">  exit &quot;$&#123;E_BAD_MOVE&#125;&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>Bash also has the <strong>PIPESTATUS</strong> variable that allows checking of the return code from all parts of a pipe. If it’s only necessary to check success or failure of the whole pipe, then the following is acceptable:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">tar -cf - ./* | ( cd &quot;$&#123;dir&#125;&quot; &amp;&amp; tar -xf - )</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;PIPESTATUS[0]&#125;&quot; -ne 0 || &quot;$&#123;PIPESTATUS[1]&#125;&quot; -ne 0 ]]; then</span><br><span class="line"></span><br><span class="line">  echo &quot;Unable to tar files to $&#123;dir&#125;&quot; &gt;&amp;2</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>However, as <strong>PIPESTATUS</strong> will be overwritten as soon as you do any other command, if you need to act differently on errors based on where it happened in the pipe, you’ll need to assign <strong>PIPESTATUS</strong> to another variable immediately after running the command (don’t forget that [ is a command and will wipe out <strong>PIPESTATUS</strong>).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">tar -cf - ./* | ( cd &quot;$&#123;DIR&#125;&quot; &amp;&amp; tar -xf - )</span><br><span class="line"></span><br><span class="line">return_codes=($&#123;PIPESTATUS[*]&#125;)</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;return_codes[0]&#125;&quot; -ne 0 ]]; then</span><br><span class="line"></span><br><span class="line">  do_something</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ &quot;$&#123;return_codes[1]&#125;&quot; -ne 0 ]]; then</span><br><span class="line"></span><br><span class="line">  do_something_else</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h3 id="7-2-Builtin-Commands-vs-External-Commands"><a href="#7-2-Builtin-Commands-vs-External-Commands" class="headerlink" title="7.2 Builtin Commands vs. External Commands"></a>7.2 Builtin Commands vs. External Commands</h3><p>Given the choice between invoking a shell builtin and invoking a separate process, choose the builtin.</p>
<p>We prefer the use of builtins such as the Parameter Expansion functions in <strong>bash(1)</strong> as it’s more robust and portable (especially when compared to things like sed).  </p>
<p> <strong><em>Example:</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># Prefer this:</span><br><span class="line"></span><br><span class="line">addition=$(($&#123;X&#125; + $&#123;Y&#125;))</span><br><span class="line"></span><br><span class="line">substitution=&quot;$&#123;string/#foo/bar&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Instead of this:</span><br><span class="line"></span><br><span class="line">addition=&quot;$(expr $&#123;X&#125; + $&#123;Y&#125;)&quot;</span><br><span class="line"></span><br><span class="line">substitution=&quot;$(echo &quot;$&#123;string&#125;&quot; | sed -e &apos;s/^foo/bar/&apos;)&quot;</span><br></pre></td></tr></table></figure>
<p><strong><a href="#contents">Go Contents</a></strong></p>
<h2 id="8-Conclusion"><a href="#8-Conclusion" class="headerlink" title="8. Conclusion"></a>8. <span id="h">Conclusion</span></h2><p>Use common sense and <strong>BE CONSISTENT</strong>.</p>
<p>Please take a few minutes to read the Parting Words section at the bottom of the <strong>C++ Guide</strong>.</p>
<p><strong><a href="#contents">Go Contents</a></strong></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/shell/" rel="tag"># shell</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/01/12/vim-surround插件/" rel="next" title="vim-surround插件">
                <i class="fa fa-chevron-left"></i> vim-surround插件
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/12/git-分支操作/" rel="prev" title="git分支操作">
                git分支操作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Niu Zhiqiang">
            
              <p class="site-author-name" itemprop="name">Niu Zhiqiang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">54</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/niuzhiqiang90" title="GitHub &rarr; https://github.com/niuzhiqiang90" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://coding.net/u/niuzhiqiang90" title="Coding &rarr; https://coding.net/u/niuzhiqiang90" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>Coding</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:niuzhiqiang90@foxmail.com" title="E-Mail &rarr; mailto:niuzhiqiang90@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Shell-Style-Guide"><span class="nav-text">Shell Style Guide</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Contents"><span class="nav-text">Contents</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Which-Shell-to-Use"><span class="nav-text">Which Shell to Use</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#When-to-use-Shell"><span class="nav-text">When to use Shell</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Shell-Files-and-Interpreter-Invocation"><span class="nav-text">1.  Shell Files and Interpreter Invocation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-File-Extensions"><span class="nav-text">1.1 File Extensions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-SUID-SGID"><span class="nav-text">1.2 SUID/SGID</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Environment"><span class="nav-text">2. Environment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-STDOUT-vs-STDERR"><span class="nav-text">2.1 STDOUT vs STDERR</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Comments"><span class="nav-text">3. Comments</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-File-Header"><span class="nav-text">3.1 File Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Function-Comments"><span class="nav-text">3.2 Function Comments</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Implementation-Comments"><span class="nav-text">3.3 Implementation Comments</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-TODO-Comments"><span class="nav-text">3.4 TODO Comments</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Formatting"><span class="nav-text">4. Formatting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Indentation"><span class="nav-text">4.1 Indentation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Line-Length-and-Long-Strings"><span class="nav-text">4.2 Line Length and Long Strings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-Pipelines"><span class="nav-text">4.3 Pipelines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-Loops"><span class="nav-text">4.4 Loops</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-Case-statement"><span class="nav-text">4.5 Case statement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-Variable-expansion"><span class="nav-text">4.6 Variable expansion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-Quoting"><span class="nav-text">4.7 Quoting</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Features-and-Bugs"><span class="nav-text">5. Features and Bugs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Command-Substitution"><span class="nav-text">5.1 Command Substitution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Test-and"><span class="nav-text">5.2 Test, [ and [[</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-Testing-Strings"><span class="nav-text">5.3 Testing Strings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-Wildcard-Expansion-of-Filenames"><span class="nav-text">5.4 Wildcard Expansion of Filenames</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-Eval"><span class="nav-text">5.5 Eval</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-Pipes-to-While"><span class="nav-text">5.6 Pipes to While</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Naming-Conventions"><span class="nav-text">6. Naming Conventions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-Function-Names"><span class="nav-text">6.1 Function Names</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-Variable-Names"><span class="nav-text">6.2 Variable Names</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-Constants-and-Environment-Variable-Names"><span class="nav-text">6.3 Constants and Environment Variable Names</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-Source-Filenames"><span class="nav-text">6.4 Source Filenames</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-Read-only-Variables"><span class="nav-text">6.5 Read-only Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-Use-Local-Variables"><span class="nav-text">6.6 Use Local Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-7-Function-Location"><span class="nav-text">6.7 Function Location</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-8-main"><span class="nav-text">6.8 main</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Calling-Commands"><span class="nav-text">7. Calling Commands</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-Checking-Return-Values"><span class="nav-text">7.1 Checking Return Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-Builtin-Commands-vs-External-Commands"><span class="nav-text">7.2 Builtin Commands vs. External Commands</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Conclusion"><span class="nav-text">8. Conclusion</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Niu Zhiqiang</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v6.6.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.6.0"></script>

  <script src="/js/src/motion.js?v=6.6.0"></script>



  
  

  
  <script src="/js/src/scrollspy.js?v=6.6.0"></script>
<script src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  






<!-- LOCAL: You can save these files to your site and update links -->
  
    
    <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
    <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
  
<!-- END LOCAL -->

  

  
    <script>
    function renderGitment(){
      var gitment = new Gitmint({
        id: window.location.pathname,
        owner: 'niuzhiqiang90',
        repo: 'niuzhiqiang90.github.io',
        
        lang: "" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
        
        oauth: {
        
        
          client_secret: '7173a08d26e2e9d68f34964f37daf1cc58c4c759',
        
          client_id: '66d495baec5be06e195e'
        }});
      gitment.render('gitment-container');
    }

    
      renderGitment();
    
    </script>
  







  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
