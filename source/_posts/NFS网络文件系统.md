---
title: NFS网络文件系统
date: 2015-11-12 14:39:22
tags: NFS
---
## 1. NFS简介
NFS，网络文件系统。NFS是中小型企业的网络共享存储选择。

## 2. 应用场景
在企业<font color=red>集群架构</font>的工作场景中，NFS网络文件系统一般被用来存储<font color=red>共享视频、图片、附件等静态资源文件</font>（一般把网站用户上传的文件都放到NFS共享里，例如：BBS产品的图片、附件、头像，<font color=red>注意网站的程序不要放NFS共享里</font>），NFS是当前互联网系统架构中最常用的数据存储服务之一，特别是中小型网站公司应用频率很高。大公司或门户除了使用NFS外，还可能会使用MFS、GFS、FASTFS、TFS等分布式文件系统。

## 3. 为什么需要共享存储
由于在企业生产集群架构中，有很多台服务器提供相同的业务，如果数据分别存到各自服务器的硬盘中，那管理起来会很复杂，于是就需要用到共享存储，将数据统一管理。

**扩展提示：**
中小型互联网企业一般不会买硬件存储，太贵，大公司如果业务发展很快的话，可能会临时买存储顶一下网站压力，当网站并发继续加大后，硬件存储扩展就像对很费劲了，且价格成几何级数增加。  
例如：淘宝网就替换掉了很多硬件设备集群软件，用`lvs+haproxy`替换了`netscaler`负载均衡设备，用`FASTFS`，`TFS`配合PC服务器替换了`netapp`、`emc`商业存储设备。

## 4. NFS原理
### 4.1 NFS的挂载
```
mount 源位置 目标位置
mount 192.168.1.200:/video  /video
```

### 4.2 NFS使用的端口
NFS会用到很多端口，且使用的端口号是随机的！那么客户端是怎么知道NFS服务端使用的是哪个端口呢？答案就是通过RPC协议/服务（远程过程调用）来实现的。

### 4.3 什么是RPC
因为NFS支持的功能相当多，而不同的功能都会使用不同的程序来启动，每启动一个功能就会启用一些端口来传输数据，因此，NFS的功能所对应的端口才无法固定，而是随机取用一些未被使用的端口来作为传输之用，其中centos5.x随机端口小于1024的，而centos6.x随机端口都是较大的。
因为端口不固定，这样一来就会造成NFS客户端与NFS服务端的通讯障碍，因为NFS客户端必须要知道服务器端的数据传输端口才能进行通信交互数据。
要解决上面的通讯问题困扰，就需要远程过程调用RPC服务来帮忙了，<font color=red>NFS的RPC服务最主要的功能就是记录每个NFS功能所对应的端口号，并且在NFS客户端请求时将该端口和功能对应的信息传递给请求数据的NFS客户端，从而可以确保客户端可以连接到正确的NFS端口上去。这个RPC服务很类似NFS服务器端和NFS客户端之间的一个中介。</font>

### 4.4 NFS和RPC协同工作的原理
TODO

## 5. 案例
实现当多台客户端同时挂一台`NFS SERVER`时，无论从哪个客户端写入数据，其它客户端同样也可以读写，即让所有`nfs`客户端写入到`nfs server`的文件或目录在`nfs server`上的用户和组都是同一个名称`user1`。请给出操作步骤。
解答：
＊环境：3台机器，2台客户端，1台服务端
1.建立一个nfs共享用户，所有机器都存在并且`UID` `GID`相同
2.查看
```
$ cat /etc/exports
/data0 192.168.13.0/24(rw,all_squash,anonuid=555,anongid=555,sync)
```

3.挂载
```
$ mount -t nfs 192.168.13.0/24:/data0 /var/html
```
